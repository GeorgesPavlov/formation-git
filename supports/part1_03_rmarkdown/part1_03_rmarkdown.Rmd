---
title: "R Markdown"
author: "Annie Moineau"
date: "`r format (Sys.time(), '%d %B, %Y')`"
output: collaboratif_format
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r, echo=FALSE, message=FALSE}
library(knitr)
library(dplyr)
library(questionr)
```


# Présentation générale de R Markdown

## C'est quoi ?

* Un mélange de R et de Markdown. 
    + Markdown est un système d'édition doté d'une syntaxe simplifiée souvent utilisé pour faire de la documentation de projet sous forme de fichier .md
    + Des morceaux de code `R` qui seront exécutés lors de la compilation du fichier peuvent être inclus
* Un fichier R Markdown est suffixé .Rmd

## Que peut produire `R markdown` ?
* des rapports en pdf, en html
* des présentations sous forme de slides
* ...

![](./pics/types_sorties.png)


## Comment fonctionne `R markdown` ? 

### La philosophie

R Markdown fonctionne : 

* Différemment d’Office. C’est un éditeur qui n'est pas `WYSIWYG` (*What you see is what you get*: ce que vous voyez est ce que vous obtenez) : le fichier est composé de texte brut. C'est une fois le fichier compilé que la mise en forme peut être visualisée dans le fichier de sortie. La philosophie est celle du `WYSIWYM` (*What you see is what you mean*: ce que vous voyez est ce que vous voulez dire)^[Un autre langage d'édition de texte qui fonctionne selon ce principe de `WYSIWYM` est `LateX`, langage souvent utilisé pour l'écriture de rapports ou articles scientifiques. En termes de syntaxe, `Rmarkdown` comporte de nombreux points communs avec `LateX` mais a l'ambition d'offrir une syntaxe simplifiée.].
* En dissociant le fond de la forme : 
   * séparation entre le texte et sa mise en forme. 
   * les illustrations sont générées dynamiquement à partir des blocs de code R intégrés, ou insérées par lien. 


## Pourquoi utiliser `R markdown`, quels sont ses avantages ? 

* la dissociation entre le fond de la forme, ce qui
    * allège les mises à jour ou correctifs de fonds
    * facilite les changements de forme, par exemple le passage d'un format `.doc` à un `.html`
    * donne de la visibilité au code ayant généré les résultats et illustrations
* la possibilité de commenter l'ensemble du document, ce qui
    * permet de détailler un résultat spécifique, d'expliquer les choix d'analyse faits
    * facilite le suivi de l'analyse, ou son appropriation par une personne externe à l'équipe projet (un membre intervenant ponctuellement à titre d'expert sur un sujet, ou encore un nouveau membre venu en renfort)
    * pour commenter : 
        * Dans le texte, pour activer/désactiver un commentaire c'est facile : **ctl + Maj + c**
            * ![](./pics/Commentaire.png)
        * à l'intérieur des blocs de code R, les commentaires se font comme dans un script R
    
* R Mardown a été pensé pour permettre une prise en main rapide et simple. Plus simple que le langage `html` ou le langage `LateX`.
* combiné au versionning, les modifications successives apportées au document sont facilement traçables, ce qui permet 
    * maitriser l'évolution du document, par exemple sur la succession de corrections, apportées tout au long d'un circuit de relecture.
    * sans empiler les fichiers
    
    

    
![](./pics/final_doc.png)


# Avant de commencer

## Les points de vigilance lorsqu'on débute 

* R Markdown est un outil collaboratif en plus, son utilisation nécessite l'adhésion de l'ensemble de l'équipe. 
* L'ensemble des contributeurs doit donc s'approprier à la fois ses principes et sa syntaxe (hors contexte collaboratif, ses avantages demeurent pour un document réalisé seul).
* correcteur automatique de document. Pour le paramétrer en français, aller dans le menu `Tools > Global Options > Spelling` et dans le menu déroulant _Main dictionary language_, sélectionner _Français_.
* actuellement pas d'outils disponible pour intégrer automatiquement la charte graphique Insee dans un document Markdown.
* les outils ne remplacent pas la communication dans l'équipe projet. La production collaborative d'un document R Markdown nécessite de se mettre d'accord sur sa structure. Il est donc nécessaire de faire des points d'équipe. Pour vous aider, il existe un [chat Insee](https://rocket-chat.stable.innovation.insee.eu) ou les *issues* dans *gitlab* qui peuvent servir de forum entre collaborateurs d'un sujet (cf. chapitre `git`)


## Les conseils lorsqu'on débute

* viser la reproductibilité : le document doit pouvoir être généré par l'ensemble de l'équipe projet.
    * tout comme pour un script R, les ressources (images, données, ...) doivent être appelées via des chemins d'accès relatifs au dossier du projet. Donc pas de chemin complet.
        * **A ne pas faire : ** d:/projets gitlab/couverturenumerique/donnees/depReg16.txt
        * **mais faire plutôt : ** ./donnees/depReg16.txt
    
    * l'emplacement de ces ressources doit respecter une arborescence connue et utilisée par tous.
    * les blocs de code doivent être reproductibles par les collaborateurs
        + L'ensemble des blocs de code présent dans un fichier est exécuté de manière linéaire: les objets ou librairies appelés dans un bloc de code doivent être accessibles (ils doivent avoir été créés avant, les packages doivent être importés...)

# Produire son premier document

Cette [ressource](https://rmarkdown.rstudio.com/lesson-1.html) (en anglais) peut servir de guide d'entrée à `Rmarkdown`

1. **Créer** un nouveau fichier Rmarkdown.

![](./pics/crea_premier_fic.png)

2. Tester. **Saisir** du texte en l'habillant de mises en formes : 
    * titres de niveaux différents avec **#** 
    * liste avec *
    * liste ordonnée avec **1.**
    * mise en italique en encadrant avec *
    * mise en gras en encadrant avec **


3. **Tricoter** (knit) pour visualiser le résultat (avec la mise en forme) dans le l'onglet Viewer.

![](./pics/knit.png)


## Anatomie d'un document R Markdown

1. en-tête contenant les métadonnées du document. Elle est délimitée entre deux lignes de pointillés. 
    * au minimum : titre du document et format de sortie.
2. des blocs de code R (chunk) encadrés par les balises **`**
    * ces chunks peuvent être nommés
    * des options peuvent être spécifiées
    * en dessous de l'en-tête : un chunk de set up pour régler les options par défaut de tous les chunks
3. des blocs de texte brut
    * habillage (mise en forme) selon la syntaxe R markdown
* Texte et code R s'alternent à volonté     


## Syntaxe de base 

### Mise en forme de texte

![](./pics/syntaxe.png)

Quand des niveaux de titre ont été définis, une table des matières est générée automatiquement.
![](./pics/table_matiere.png)

### Insérer un lien hypertexte


![](./pics/inserer_lien.png)

une adresse utile <https://rmarkdown.rstudio.com/>


En remplaçant l'url par un alias

![](./pics/inserer_lien_nom.png)

une adresse utile [ici](https://rmarkdown.rstudio.com)

### Insérer une image

![](./pics/inserer_img.png)

![](./pics/CaptureInsee.png)

### Exercice 1

**Créer un fichier R Markdown produisant la sortie suivante :** 
![](./pics/capture_exo1.png)

### Insérer du code R : 3 options

#### 1. Insertion en ligne par délimiteur **`** (alt Gr + 7)

Pour insérer le résultat d'une instruction simple, à l'intérieur d'un texte : 

![](./pics/inserer Rsimple.png)

* Exemple 1 : Voici le résultat de l'instruction R dim(mtcar) : `r dim(mtcars)`

* Exemple 2 : 
    * On peut aussi insérer la date du jour comme ceci : `r format (Sys.time(), '%d %B, %Y')`.
    
    * Ou comme cela : nous sommes le jour `r format (Sys.time(), '%d')`, du mois `r format (Sys.time(), '%B')` , de l'année `r format (Sys.time(), '%Y')`.

#### 2. Insertion d'un bloc de code R : *chunks*

L'une des fonctionalités pratiques de `Rmarkdown` est qu'il est possible d'insérer des blocs (*chunks*) entiers de code entre deux paragraphes de texte. Pour réaliser l'insertion de ce type de blocs, le code doit être délimité de la façon suivante :

![](./pics/inserer_R.png)
```{r, message = FALSE}
# Insérer du code R dans un fichier R Markdown c est facile
dim(mtcars) 
```

`Rmarkdown` introduit ainsi un bloc de code et affiche le résultat des instructions en dessous. C'est particulièrement pratique pour afficher quelques lignes d'exemple ou des résultats. Par exemple,

```{r}
head(mtcars)
```

permettra à tout utilisateur de connaître la structure des données d'exemple (attention, on n'affiche pas des données confidentielles!). 

* **Remarque importante** : à chaque compilation une nouvelle session R est lancée, vierge de tout objet créé. Les premiers blocs de code sont alors souvent dédiés au chargement des packages, à l'importation des données, au recodage.

* Raccourci clavier pour insérer un bloc de code R : **Ctrl + Alt + i**
* Remarque pratique : dans le cas du format de sortie Html, par défaut le fichier .html est créé. Ce dernier contient le résultat du code (mise en forme, illustrations), et peut être facilement transmis.

* Plusieurs options sont disponibles : 
    
    * **echo** mis à `FALSE` permet de ne pas afficher l'instruction R
    * **eval** mis à `FALSE` permet de ne pas exécuter le code du chunk
    * **results** mis à `"hide"` permet d'exécuter le code sans afficher l'output
    * **message** mis à `FALSE` permet de ne pas afficher les messages d'information
    * **warning** mis à `FALSE` permet de ne pas afficher les messages de warning
    * **cache** mis à TRUE permet de mettre le résultat du chunk en cache. En effet, il est à la fois coûteux et inutile d'exécuter certaines instructions R à chaque fois (importation de tables par exemple). Dans ce cas, au moment d'une première exécution, le résultat d'un chunk peut être mis en cache, c'est à dire en mémoire grâce à l'option **cache = TRUE**. Attention si vous utilisez le cache : vous ne devez jamais le pousser sur GitLab et donc ajouter la ligne `*_cache/` au fichier `.gitignore` de votre projet.

<!--- Remarque de Lino: là ça vaut le coup de montrer au moins un exemple parce que sinon l'utilisateur qui n'a jamais fait de Rmarkdown ne saura pas où insérer ces options --->

~~~markdown
`r ''````{r, results = "hide"}
print("toto")
`r ''````
~~~

#### 3. Appeler un script

Afin de mieux organiser son code, un même projet peut avoir plusieurs scripts. Même s'il est possible d'utiliser la fonction `source()` dans un document R Markdown, cette pratique n'est pas recommandée. Dans ce cadre, il est préférable d'utiliser l'option `code` pour le chunk.

Voici un exemple :

~~~markdown
`r ''````{r, message=TRUE, echo=TRUE, code=readLines("./pgm/librairies.R", encoding="UTF-8")}
`r ''````
~~~

```{r, message=TRUE, echo=TRUE, code=readLines("./pgm/librairies.R", encoding = "UTF-8")}
```


### Insérer de beaux tableaux

La fonction **kable** du package `knitr` permet très facilement d'améliorer l'affichage de tableaux.

Exemple avec le jeu de données Insee `histoires de vie 2003 (hdv2003)` inclus directement dans la package **questionr**.

* Sans fonction kable

```{r, echo=TRUE, cache = TRUE}
data(hdv2003)
hdv2003 %>% 
    group_by(bricol, cuisine) %>% 
    summarise(sum = round(sum(poids))) -> res;res
```

* Avec l'instruction kable : 

```{r, echo=TRUE}
kable(res, caption = "hdv2003 - bricol x cuisine - afichage avec la fonction kable")

```

### Exercice 2

<!---- Par fichier, qu'est-ce que tu entends ? Le `rmd` de l'exercice 1 ? ---->
Modifier le fichier précédent en ajoutant une instruction R de votre choix.
Vous pourrez par exemple utiliser les données `mtcars`

## Boite à outils 

* Consulter la **Cheat sheet** R Markdown disponible sur le site de R Studio **https://rstudio.com**

![](./pics/cheat sheet Rmarkdown.png)


* **CodiMD** : interface disponible sur la plateforme innovation
[lien](https://hackmd.beta.innovation.insee.eu)

Permet de visualiser en direct le résultat
![](./pics/CodiMD.png)

# Résumé

>* Réaliser un document R Mardown est simple, mais la visualisation du résultat requiert une étape de compilation du fichier .Rmd
>* Un fichier .Rmd mélange :
>    * du texte balisé selon la syntaxe Markdown
>    * des bouts de code R
>* Le résultat d'une instruction R peut soit, s'insérer directement dans le texte, soit être contenu dans un bloc de code appelé chunk.






